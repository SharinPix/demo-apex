<apex:page controller="SharinPixDemoAlbumImageDownloadCtrl" showHeader="false" sidebar="false" standardStylesheets="false">
	Please wait...<br />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js" integrity="sha256-RbP/rbx4XeYJH6eYUniR63Jk5NEV48Gjestg49cNSWY=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.3/FileSaver.min.js" integrity="sha256-FPJJt8nA+xL4RU6/gsriA8p8xAeLGatoyTjldvQKGdE=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <script type="text/javascript">
        var getParameter = function(parameter){
            var query = window.location.search.substring(1);
            var vars = query.split("&");
            for(var i=0;i<vars.length;i++){
                var pair = vars[i].split("=");
                if(pair[0] == parameter) return pair[1];
            }
            return null;
        };

        var image = JSON.parse('{!jsonImages}');
        function downloadImages(images, callback){
            if(images.length === 0){
                $(document.body).append('No images to extract.<br />');
                resolve(images);
            }
            var numImagesFetched = 0;
            var deferred = $.Deferred();
            images.forEach(function(image){
                var req = new XMLHttpRequest();
                req.open("GET", image.url, true);
                req.responseType = "blob";
                req.onload = function(event){
                    image.data = req.response;
                    numImagesFetched++;
                    $(document.body).append('Retrieved image '+numImagesFetched+' of '+images.length+'<br/>');
                    if(numImagesFetched === images.length){
                        deferred.resolve(images);
                    }
                };
                req.send();
            });
            deferred.done(callback);
        }

        downloadImages(images, function(){
            var zip = new JSZip();
            $(document.body).append('Zipping...<br />');
            deferreds = [];
            images.forEach(function(image){
                deferreds.push(zip.file(image.name, image.data, { binary : true }));
            });
            $.when.apply($, deferreds).then(function(){
                zip.generateAsync({ type: "blob" }).then(function(content){
                    saveAs(content, decodeURIComponent(getParameter('filename') || "Images").replace(/\+/g, ' ')+".zip");
                });
            });
        });
    </script>
</apex:page>