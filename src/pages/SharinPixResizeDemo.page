<apex:page showHeader="true" sidebar="true" controller="SharinPixResizeDemo">
    <script>
    var latestImageViewed = null;
    var newWindow;
    var ifImageSelected = function (func) {
        if (latestImageViewed) {
            newWindow = window.open('https://s-media-cache-ak0.pinimg.com/originals/0c/44/da/0c44dacf1b038014a6f941131c5e8aa2.gif', '_blank');
            func();
        } else {
            alert('Select an image from the album first!');
        }
        return false;
    }
    var buttonClicked = function() {
        var height = document.getElementById('image_height').value;
        var width = document.getElementById('image_width').value;
        var crop = document.getElementById('crop').value;
        Visualforce.remoting.Manager.invokeAction(
            '{! $RemoteAction.SharinPixResizeDemo.resizeImage }',
            latestImageViewed, width, height, crop,
            function(res) {
                newWindow.location = res;
            }
        );
    }
    var eventMethod = window.addEventListener ? "addEventListener" : "attachEvent";
    var eventer = window[eventMethod];
    var messageEvent = eventMethod == "attachEvent" ? "onmessage" : "message";
    eventer(messageEvent, function(e) {
        if (e.origin === 'https://app.sharinpix.com') {
            var data = e.data;
            switch (data.name) {
                case 'viewer-image-viewed':
                    latestImageViewed = data.payload.image.public_id;
                    break;
                case 'viewer-closed':
                    latestImageViewed = null
            }
        }
    }, false);
    setInterval(function() {
        var mainForm = document.getElementById('{!$Component.main_form}');
        var warningMessage = document.getElementById('warning_message');
        if (!mainForm || !warningMessage) return;
        if (latestImageViewed) {
            mainForm.style.display = 'block';
            warningMessage.style.display = 'none';
        } else {
            mainForm.style.display = 'none';
            warningMessage.style.display = 'block';
        }
    }, 200)
    </script>
    <apex:canvasApp developerName="Albums" height="450px" width="100%" parameters="{! parameters }" />
    <apex:form onsubmit="return false" id="main_form">
        <hr />
        <h1>Resize/Crop</h1><br /><br />
        Height:<br />
        <input type="number" value="100" id="image_height" /><br /><br />
        Width:<br />
        <input type="number" value="150" id="image_width" /><br /><br />
        Crop type:<br />
        <select id="crop">
            <option>scale</option>
            <option>fit</option>
            <option>fill</option>
            <option>pad</option>
            <option>crop</option>
            <option>thumb</option>
        </select><br /><br />
        <apex:commandButton value="Resize" id="resize_button" onclick="return ifImageSelected(buttonClicked)" /> <br />
    </apex:form>
    <div id="warning_message">
        Click on an image first...
    </div>
</apex:page>